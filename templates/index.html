<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HMT FoosRater</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static',filename='styles/styles.css') }}">
</head>
<body>
    <div class="container-fluid">
        <div class="row fixed-top bg-dark text-white d-flex justify-content-center align-items-center" style="height: 60px;">
            <div class="col-auto">
                <button class="btn btn-dark mx-2" data-toggle="modal" data-target="#overlay1">Ranking</button>
                <button class="btn btn-dark mx-2" data-toggle="modal" data-target="#overlay2">Add game</button>
                <a class="btn btn-dark" target="_blank" href="https://github.com/robbertmijn/foosrater"><i class="fab fa-github"></i></a>
            </div>
        </div>
        <div class="container my-2">
            <br>
            <br>
            <br>
            <br>
            <table class="table">
                <tbody>
                    {% for game in games %}
                    <tr>
                        <td class="id-date">
                            <div class="d-flex flex-column align-items-center">
                                <strong># {{ game.id }}</strong>
                                <small>{{ game.date_time }}</small>
                            </div>
                        </td>
                        <td class="team">
                            <div class="team-container team-red">
                                <div class="player-card">
                                    <span class="emoji">{{ game.R1.league }}</span>
                                    <span class="player-name">{{ game.R1.name }}</span>
                                    <span class="player-rating">{{ game.r1_elo_delta | default(0) | round(1) }}</span>
                                </div>
                                {% if game.R2.name != "" %}
                                <div class="player-card">
                                    <span class="emoji">{{ game.R2.league }}</span>
                                    <span class="player-name">{{ game.R2.name }}</span>
                                    <span class="player-rating">{{ game.r2_elo_delta | default(0) | round(1) }}</span>
                                </div>
                                {% endif %}
                            </div>
                        </td>
                        <td class="score">
                            <div class="goal-container">
                                <span>{{ game.red_score }} - {{ game.blue_score }}</span>
                            </div>
                        </td>
                        <td class="team">
                            <div class="team-container team-blue">
                                <div class="player-card">
                                    <span class="emoji">{{ game.B1.league }}</span>
                                    <span class="player-name">{{ game.B1.name }}</span>
                                    <span class="player-rating">{{ game.b1_elo_delta | default(0) | round(1) }}</span>
                                </div>
                                {% if game.B2.name != "" %}
                                <div class="player-card">
                                    <span class="emoji">{{ game.B2.league }}</span>
                                    <span class="player-name">{{ game.B2.name }}</span>
                                    <span class="player-rating">{{ game.b2_elo_delta | default(0) | round(1) }}</span>
                                </div>
                                {% endif %}
                            </div>
                        </td>
                        <td class="actions">
                            <div class="action-icons">
                                <i class="fas fa-pencil-alt" style="cursor: pointer;" 
                                onclick="window.location.href='{{ url_for("edit_game", league_name=league_name, game_id=loop.index0) }}'"></i>
                                <i class="fas fa-trash" style="cursor: pointer;" 
                                onclick="sendPostRequest('{{ url_for("delete_game", league_name=league_name,  game_id=loop.index0) }}')"></i>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
    
                </tbody>
            </table>
        </div>
    <!-- </div> -->

    <div class="modal fade" id="overlay2" tabindex="-1" role="dialog" aria-labelledby="overlay2Label" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="overlay2Label">Add game</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ category }}">{{ message }}</div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}
                    <form method="POST" id="foosform">
                        {{ form.hidden_tag() }}
            
                        <label for="red-team" class="form-label">Red Team:</label>
                        <div class="input-group mb-3">
                            {{ form.red_score(class="form-select", id="red_score") }}
                            {{ form.player_red1(class="form-control", placeholder="Player 1", required=True, list="suggestionsList") }}
                            {{ form.player_red2(class="form-control", placeholder="Player 2", list="suggestionsList") }}
                        </div>
            
                        <label for="blue-team" class="form-label">Blue Team:</label>
                        <div class="input-group mb-3">
                            {{ form.blue_score(class="form-select", id="blue_score") }}
                            {{ form.player_blue1(class="form-control", placeholder="Player 1", required=True, list="suggestionsList") }}
                            {{ form.player_blue2(class="form-control", placeholder="Player 2", list="suggestionsList") }}
                        </div>
            
                        <div class="form-group mb-3">
                            <label for="date">Date & Time:</label>
                            {{ form.date_time(class="form-control", type="datetime-local", required=True, id="date") }}
                        </div>
            
                        <div id="error-message" class="text-danger mb-3" style="display: none;">At least one goal must be made!</div>
            
                        <button type="submit" class="btn btn-primary w-100">{{ form.submit.label }}</button>
                    </form>
                    
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="overlay1" tabindex="-1" role="dialog" aria-labelledby="overlay1Label" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="overlay1Label">Ranking</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <ul class="list-group">
                        {% for player in players_ranked %}
                            <li class="list-group-item d-flex">
                                {{ player.ranking }}.&nbsp;<span data-toggle="modal" data-target="#overlay3" class="name-link" data-name= {{ player.name }} > {{ player.name }}</span>&nbsp;(elo: {{ player.elo[-1] | int }}, {{ player.n_games }} games, {{ player.league }} league)
                            </li>
                        {% endfor %}
                        {% for player in players_unranked %}
                            <li class="list-group-item d-flex">
                                #.&nbsp;<span data-toggle="modal" data-target="#overlay3" class="name-link" data-name= {{ player.name }} > {{ player.name }}</span>&nbsp;(elo: {{ player.elo[-1] | int }}, {{ player.n_games }} games, {{ player.league }} league)
                            </li>
                        {% endfor %}

                        <datalist id="suggestionsList">
                            {% for player in players_ranked %}
                            <option value="{{ player.name }}"">
                            {% endfor %}
                            {% for player in players_unranked %}
                            <option value="{{ player.name }}"">
                            {% endfor %}
                        </datalist>

                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="overlay3" tabindex="-1" role="dialog" aria-labelledby="overlay3Label" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="overlay3Label">&nbsp;</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <h6>Top 5 opponents:</h6>
                    <ol id="list-opponents"></ol>
                    <h6>Top 5 teammates:</h6>
                    <ol id="list-teammates"></ol>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            let now = new Date();

            // Set date field (YYYY-MM-DD)
            let dateField = document.getElementById('date');
            let year = now.getFullYear();
            let month = String(now.getMonth() + 1).padStart(2, '0');
            let day = String(now.getDate()).padStart(2, '0');
            let hours = String(now.getHours()).padStart(2, '0');
            let minutes = String(now.getMinutes()).padStart(2, '0');
            let dateTimeField = document.getElementById('date_time');
            if (dateTimeField) {
                dateTimeField.value = `${year}-${month}-${day}T${hours}:${minutes}`;
            }
        });
        document.getElementById('date').valueAsDate = new Date();
        document.getElementById('foosform').addEventListener('submit', function(event) {
            const dropdown1 = parseInt(document.getElementById('blue_score').value);
            const dropdown2 = parseInt(document.getElementById('red_score').value);
            const sum = dropdown1 + dropdown2;

            if (sum < 1) {
                event.preventDefault();
                document.getElementById('error-message').style.display = 'block';
            } else {
                document.getElementById('error-message').style.display = 'none';
            }
        })

        function fetchData(name) {
            fetch(`/player/${name}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('overlay3Label').textContent = data.name;
                    
                    const listContainer1 = document.getElementById('list-opponents');
                    listContainer1.innerHTML = '';
                    data.opponents.forEach(item => {
                        const listItem = document.createElement('li');
                        listItem.textContent = `${item[0]}: ${item[1].opponent} (kill-death ratio: ${(item[1].made/item[1].let).toFixed(2)})`;
                        listContainer1.appendChild(listItem);
                    });

                    const listContainer2 = document.getElementById('list-teammates');
                    listContainer2.innerHTML = '';
                    data.teammates.forEach(item => {
                        const listItem = document.createElement('li');
                        listItem.textContent = `${item[0]}: ${item[1]}`;
                        listContainer2.appendChild(listItem);
                    });

                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                });
        }

        document.querySelectorAll('.name-link').forEach(item => {
            item.addEventListener('click', function() {
                const name = this.getAttribute('data-name');
                console.log(name)
                fetchData(name);  // Call fetch function with the clicked word
            });
        });

        function sendPostRequest(url) {
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
            }).then(response => {
                if (response.ok) {
                    location.reload(); // Reload the page or handle success
                } else {
                    alert('Failed to delete the game.');
                }
            }).catch(error => {
                console.error('Error:', error);
            });
}   

    </script>
</body>
</html>
